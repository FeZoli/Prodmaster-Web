{{extend 'layout.html'}}
<h3>
    {{=db.partner[waybill.partner].name}}, {{=waybill.date_of_delivery}}
</h3>
<div>
    {{=intake_link}}
</div>

{{if is_list:}}
    <div style="width:100%;text-align:right;">
        {{url = URL('import_data')}}
        <form action="{{=url}}" method="post" enctype="multipart/form-data">
            <input name="upload" type="file" size="60" maxlength="100000" />
            {{=T('Day:')}}&nbsp;<input name="import_day" size="2" /></br>
            <input name="waybill" type="hidden" value="{{=request.vars.waybill}}" />
            <input type="submit" value="{{=T('Import data from file')}}" />
        </form>
    </div>
{{pass}}

{{if form:}}
    {{=form}}
{{pass}}

{{if not is_list:}}
<!-- if not is_list... -->
<script>
function update_stock_fields() {
        $('#product_select').prop('disabled', true);
        $('#unit_text').prop('disabled', true);
        $('#unit_price_recorded').prop('disabled', true);

        var prod_id = $("#product_select").val();
        var url = '/' + '{{=request.application}}' + '/products/get_unit_name/?product_id=' + prod_id;
        $.get(url, function(result) {
            $('#unit_text').text(result);
        });

        var url3 = '/' + '{{=request.application}}'
                    + '/products/get_last_or_recorded_price_of_product/?product_id=' + prod_id
                    + '&partner_id=' + {{=waybill.partner}};
        $.get(url3, function(result) {
            $('#unit_price_recorded').val(result);
        });

        var url2 = '/' + '{{=request.application}}' + '/actual_stock/get_actual_stock_of_product.xml/?product_id=' + prod_id;
        $.get(url2, function(result) {
             var row = '';
             $(result).find("item").each(function() {
                row += '<tr class="sid_row"><td>'
                       + $(this).find('serial_id').text() + '&nbsp;';
                 if ($(this).find('serial_id').text() != 'Total') {
                    row += $(this).find('quantity').text() + '</td>'
                           +'<td><input name="sid:' + $(this).find('serial_id').text() + '"/></td></tr>';
                 } else {
                     row += '<td>' + $(this).find('quantity').text() + '</td></tr>';
                 }

             });
            $('.sid_row').remove();
            $('#datatable').after(row);
            $('#product_select').prop('disabled', false);
            $('#unit_text').prop('disabled', false);
            $('#unit_price_recorded').prop('disabled', false);
        });
}

$( document ).ready(function() {
    $('#product_select').change(function() {
        update_stock_fields();
    });
});
</script>
<!-- if not is_list... -->
{{pass}}

{{if len(request.args) > 0 and request.args[0] == 'edit':}}
<script>
    update_stock_fields();
</script>
{{pass}}
